name: Governance

on:
  pull_request:
  push:
    branches: [ main ]

jobs:
  checks:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Hygiene
        run: tools/hygiene/repo_hygiene.sh
      
      - name: Governance Monitor
        run: python3 tools/governance/governance_monitor
      
      - name: Coverage Gate
        env: { COVERAGE_THRESHOLD: "0.95" }
        run: tools/quality/coverage_gate.sh
      
      - name: Compliance
        run: python3 scripts/compliance_checker.py

      - name: PyTest (unit+critical)
        run: |
          python3 -m pip install --break-system-packages pytest-cov httpx prometheus_client opentelemetry-sdk opentelemetry-instrumentation-fastapi opentelemetry-exporter-otlp-proto-grpc
          python3 -m pytest -q --maxfail=1 --disable-warnings --cov=src --cov=scripts --cov-report=term --cov-report=xml tests/critical/

      - name: Package Coverage Gate
        run: python3 tools/quality/coverage_packages_gate.py

      - name: PR Study Enforcer
        env:
          GITHUB_EVENT_NAME: ${{ github.event_name }}
          GITHUB_EVENT_PATH: ${{ github.event_path }}
        run: tools/governance/pr_study_enforcer.sh

      - name: Fast Tests
        run: |
          echo "üöÄ Running Fast Test Suite..."
          npm run test:unit
          npm run test:integration
          echo "‚úÖ Fast tests completed successfully"

      - name: Infrastructure Validation
        run: |
          echo "üèóÔ∏è Validating Infrastructure as Code..."
          cd infrastructure/terraform
          terraform init -backend=false
          terraform validate
          echo "‚úÖ Infrastructure validation passed"

      - name: Helm Chart Validation
        run: |
          echo "‚öì Validating Helm Charts..."
          helm template test infrastructure/helm/modamoda --dry-run
          echo "‚úÖ Helm charts validation passed"

      - name: Generate PR Comment
        if: github.event_name == 'pull_request'
        run: |
          echo "## üìä Governance Check Results" > pr_comment.md
          echo "" >> pr_comment.md
          echo "### Coverage Status" >> pr_comment.md
          if [ -f coverage_report.txt ]; then
            cat coverage_report.txt >> pr_comment.md
          else
            echo "Coverage report not found" >> pr_comment.md
          fi
          echo "" >> pr_comment.md
          echo "### Compliance Status" >> pr_comment.md
          if [ -f compliance_report.txt ]; then
            cat compliance_report.txt >> pr_comment.md
          else
            echo "Compliance report not found" >> pr_comment.md
          fi

      - name: Comment on PR
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const comment = fs.readFileSync('pr_comment.md', 'utf8');

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });

      - name: Discord Notification
        if: always()
        run: |
          # Prepare notification message
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            TITLE="üîç PR Check: ${{ github.event.pull_request.title }}"
            URL="${{ github.event.pull_request.html_url }}"
          else
            TITLE="üîÑ Push Check on main"
            URL="${{ github.server_url }}/${{ github.repository }}/commit/${{ github.sha }}"
          fi

          STATUS="‚úÖ PASSED"
          if [ "${{ job.status }}" = "failure" ]; then
            STATUS="‚ùå FAILED"
          fi

          MESSAGE="**$TITLE**
          Status: $STATUS
          Branch: \`${{ github.ref_name }}\`
          Commit: [\`${{ github.sha }}\`](${{ github.server_url }}/${{ github.repository }}/commit/${{ github.sha }})
          [View Details]($URL)"

          # Send to Discord (if webhook URL is configured)
          if [ -n "${{ secrets.DISCORD_WEBHOOK }}" ]; then
            curl -H "Content-Type: application/json" \
                 -d "{\"content\": \"$MESSAGE\"}" \
                 ${{ secrets.DISCORD_WEBHOOK }}
          fi

      - name: Slack Notification
        if: always()
        run: |
          # Prepare notification message for Slack
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            TITLE="üîç PR Check: ${{ github.event.pull_request.title }}"
            URL="${{ github.event.pull_request.html_url }}"
          else
            TITLE="üîÑ Push Check on main"
            URL="${{ github.server_url }}/${{ github.repository }}/commit/${{ github.sha }}"
          fi

          STATUS="‚úÖ PASSED"
          if [ "${{ job.status }}" = "failure" ]; then
            STATUS="‚ùå FAILED"
          fi

          PAYLOAD="{
            \"text\": \"$TITLE\",
            \"blocks\": [
              {
                \"type\": \"section\",
                \"text\": {
                  \"type\": \"mrkdwn\",
                  \"text\": \"$TITLE\"
                }
              },
              {
                \"type\": \"section\",
                \"fields\": [
                  {
                    \"type\": \"mrkdwn\",
                    \"text\": \"*Status:* $STATUS\"
                  },
                  {
                    \"type\": \"mrkdwn\",
                    \"text\": \"*Branch:* \`${{ github.ref_name }}\`\"
                  },
                  {
                    \"type\": \"mrkdwn\",
                    \"text\": \"*Commit:* <${{ github.server_url }}/${{ github.repository }}/commit/${{ github.sha }}|\`${{ github.sha }}\`>\"
                  }
                ]
              },
              {
                \"type\": \"actions\",
                \"elements\": [
                  {
                    \"type\": \"button\",
                    \"text\": {
                      \"type\": \"plain_text\",
                      \"text\": \"View Details\"
                    },
                    \"url\": \"$URL\"
                  }
                ]
              }
            ]
          }"

          # Send to Slack (if webhook URL is configured)
          if [ -n "${{ secrets.SLACK_WEBHOOK }}" ]; then
            curl -X POST -H 'Content-type: application/json' \
                 --data "$PAYLOAD" \
                 ${{ secrets.SLACK_WEBHOOK }}
          fi

  tfsec:
    name: tfsec
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: aquasecurity/tfsec-action@v1.0.3
        with:
          working_directory: infrastructure/terraform
          additional_args: --minimum-severity HIGH
