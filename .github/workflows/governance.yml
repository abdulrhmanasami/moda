name: Governance

on:
  pull_request:
    branches: [ main, '**' ]
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  checks:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install helm
        run: |
          curl -fsSL https://raw.githubusercontent.com/helm/helm/main/scripts/get-helm-3 | bash
      - name: Install kubeconform
        run: |
          curl -L https://github.com/yannh/kubeconform/releases/download/v0.6.6/kubeconform-linux-amd64.tar.gz \
          | tar xz && sudo mv kubeconform /usr/local/bin/ && rm -f kubeconform-linux-amd64.tar.gz
      - name: Install kube-linter
        run: |
          curl -L https://github.com/stackrox/kube-linter/releases/download/v0.6.6/kube-linter-linux.tar.gz \
          | tar xz && sudo mv kube-linter /usr/local/bin/ && rm -f kube-linter-linux.tar.gz
      - name: Install promtool
        run: |
          curl -L https://github.com/prometheus/prometheus/releases/download/v2.53.1/prometheus-2.53.1.linux-amd64.tar.gz \
          | tar xz && sudo mv prometheus-2.53.1.linux-amd64/promtool /usr/local/bin/ && rm -rf prometheus-2.53.1.linux-amd64
      - name: Make scripts executable
        run: chmod +x tools/observability/*.sh || true

      - name: Hygiene
        run: tools/hygiene/repo_hygiene.sh
      
      - name: Governance Monitor
        run: python3 tools/governance/governance_monitor.py
      
      - name: Coverage Gate
        env: { COVERAGE_THRESHOLD: "0.80" }
        run: tools/quality/coverage_gate.sh
      
      - name: Compliance
        run: python3 tools/compliance/compliance_checker.py

      - name: Generate PR Comment
        if: github.event_name == 'pull_request'
        run: |
          echo "## üìä Governance Check Results" > pr_comment.md
          echo "" >> pr_comment.md
          echo "### Coverage Status" >> pr_comment.md
          if [ -f coverage_report.txt ]; then
            cat coverage_report.txt >> pr_comment.md
          else
            echo "Coverage report not found" >> pr_comment.md
          fi
          echo "" >> pr_comment.md
          echo "### Compliance Status" >> pr_comment.md
          if [ -f compliance_report.txt ]; then
            cat compliance_report.txt >> pr_comment.md
          else
            echo "Compliance report not found" >> pr_comment.md
          fi

      - name: Comment on PR
        if: github.event_name == 'pull_request' && success()
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const comment = fs.readFileSync('pr_comment.md', 'utf8');

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });

      - name: Discord Notification
        if: always()
        run: |
          # Prepare notification message
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            TITLE="üîç PR Check: ${{ github.event.pull_request.title }}"
            URL="${{ github.event.pull_request.html_url }}"
          else
            TITLE="üîÑ Push Check on main"
            URL="${{ github.server_url }}/${{ github.repository }}/commit/${{ github.sha }}"
          fi

          STATUS="‚úÖ PASSED"
          if [ "${{ job.status }}" = "failure" ]; then
            STATUS="‚ùå FAILED"
          fi

          MESSAGE="**$TITLE**
          Status: $STATUS
          Branch: \`${{ github.ref_name }}\`
          Commit: [\`${{ github.sha }}\`](${{ github.server_url }}/${{ github.repository }}/commit/${{ github.sha }})
          [View Details]($URL)"

          # Send to Discord (if webhook URL is configured)
          if [ -n "${{ secrets.DISCORD_WEBHOOK }}" ]; then
            curl -H "Content-Type: application/json" \
                 -d "{\"content\": \"$MESSAGE\"}" \
                 ${{ secrets.DISCORD_WEBHOOK }}
          fi

      - name: Slack Notification
        if: always()
        run: |
          # Prepare notification message for Slack
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            TITLE="üîç PR Check: ${{ github.event.pull_request.title }}"
            URL="${{ github.event.pull_request.html_url }}"
          else
            TITLE="üîÑ Push Check on main"
            URL="${{ github.server_url }}/${{ github.repository }}/commit/${{ github.sha }}"
          fi

          STATUS="‚úÖ PASSED"
          if [ "${{ job.status }}" = "failure" ]; then
            STATUS="‚ùå FAILED"
          fi

          PAYLOAD="{
            \"text\": \"$TITLE\",
            \"blocks\": [
              {
                \"type\": \"section\",
                \"text\": {
                  \"type\": \"mrkdwn\",
                  \"text\": \"$TITLE\"
                }
              },
              {
                \"type\": \"section\",
                \"fields\": [
                  {
                    \"type\": \"mrkdwn\",
                    \"text\": \"*Status:* $STATUS\"
                  },
                  {
                    \"type\": \"mrkdwn\",
                    \"text\": \"*Branch:* \`${{ github.ref_name }}\`\"
                  },
                  {
                    \"type\": \"mrkdwn\",
                    \"text\": \"*Commit:* <${{ github.server_url }}/${{ github.repository }}/commit/${{ github.sha }}|\`${{ github.sha }}\`>\"
                  }
                ]
              },
              {
                \"type\": \"actions\",
                \"elements\": [
                  {
                    \"type\": \"button\",
                    \"text\": {
                      \"type\": \"plain_text\",
                      \"text\": \"View Details\"
                    },
                    \"url\": \"$URL\"
                  }
                ]
              }
            ]
          }"

          # Send to Slack (if webhook URL is configured)
          if [ -n "${{ secrets.SLACK_WEBHOOK }}" ]; then
            curl -X POST -H 'Content-type: application/json' \
                 --data "$PAYLOAD" \
                 ${{ secrets.SLACK_WEBHOOK }}
          fi
