<!-- @Study:ST-014 -->
<!-- @Study:ST-013 -->
<!-- @Study:ST-011 -->
<!-- @Study:ST-005 -->
# @Study:ST-019
# دراسة احترافية للمرحلة الثانية: الإصدار الأول (V1.0)
## Professional Study for Phase 2: Version 1.0 (Feature Expansion & Scalability)

**المؤلف:** Manus AI (كبير المهندسين)
**التاريخ:** 2 نوفمبر 2025
**الهدف:** التخطيط للانتقال من إثبات المفهوم (MVP) إلى إطلاق منتج تجاري قابل للتوسع يعتمد على نموذج **الخدمة السحابية (SaaS)**، مع تحسين تجربة المستخدم على الموبايل وتوسيع خيارات التوليد.

---

## 1. الجانب الهندسي وقابلية التوسع (Scalability & Backend Engineering)

### أ. هيكلية الخدمة السحابية (SaaS Architecture)

تعتمد هيكلية V1.0 على مبدأ **الفصل بين الواجهة الأمامية (Frontend) والواجهة الخلفية (Backend)**، مع التركيز على قابلية التوسع الأفقي (Horizontal Scaling) للواجهة الخلفية التي تحمل عبء معالجة الذكاء الاصطناعي.

| المكون | التوصية | تحليل قابلية التوسع |
| :--- | :--- | :--- |
| **الواجهة الأمامية** | **React/Next.js (PWA)** | يمكن استضافتها على خدمات استضافة ثابتة (Static Hosting) مثل Vercel أو Netlify أو AWS S3/CloudFront، مما يضمن سرعة تحميل عالية وتكلفة منخفضة. |
| **الواجهة الخلفية (API)** | **FastAPI (Python)** | يجب نشرها في بيئة سحابية تدعم التوسع التلقائي (Auto-Scaling) مثل AWS ECS/EKS أو Google Cloud Run. يتم قياس عدد النسخ (Instances) بناءً على حمل الطلبات الواردة. |
| **عوامل Celery (Workers)** | **Celery Workers** | يجب أن تعمل في بيئة منفصلة عن الواجهة الخلفية للـ API، مع إمكانية التوسع التلقائي بناءً على طول **قائمة انتظار المعالجة (Processing Queue)**. يجب استخدام وحدات معالجة رسومية (GPUs) متخصصة (مثل NVIDIA A10G أو A100) لضمان سرعة المعالجة. |
| **قواعد البيانات** | **PostgreSQL (Managed Service)** | استخدام خدمة مُدارة (Managed Service) مثل AWS RDS أو Google Cloud SQL لضمان التوافر العالي (High Availability) والنسخ الاحتياطي التلقائي. |

#### تحسين الأداء وإدارة قائمة الانتظار (Celery/Redis Optimization)

لضمان أن المستخدم "لا ينتظر أكثر من بضع ثوانٍ قبل أن يتم إخباره بأن مهمة المعالجة قيد التنفيذ"، يجب تحسين إعدادات Celery/Redis:

1.  **الفصل بين المهام:** في V1.0، يجب فصل قوائم الانتظار (Queues) لمهام الذكاء الاصطناعي الثقيلة عن المهام الخفيفة (مثل إرسال رسائل البريد الإلكتروني).
2.  **إعدادات Celery:** يجب ضبط `CELERY_WORKER_PREFETCH_MULTIPLIER` على قيمة منخفضة (مثل 1) لضمان أن كل عامل (Worker) يعالج مهمة واحدة في كل مرة، مما يمنع احتكار المهام الطويلة.
3.  **المراقبة (Monitoring):** يجب تطبيق نظام مراقبة متقدم (مثل Prometheus و Grafana) لمراقبة طول قائمة الانتظار (Queue Length) واستخدام موارد الـ GPU، مما يسمح للنظام بالتوسع التلقائي (Auto-Scale) بشكل استباقي قبل حدوث اختناقات.

### ب. استراتيجية تخزين الملفات (File Storage Strategy)

| المكون | التوصية | آلية العمل في V1.0 |
| :--- | :--- | :--- |
| **خدمة التخزين** | **Amazon S3 أو Google Cloud Storage** | توفر قابلية توسع لا نهائية وتكلفة فعالة. |
| **آلية الرفع (Upload)** | **الرفع المباشر (Pre-Signed URLs)** | يجب أن يقوم المستخدم برفع الصورة مباشرة إلى S3/GCS باستخدام رابط موقع مسبقاً (Pre-Signed URL) يتم إنشاؤه بواسطة الواجهة الخلفية. هذا يقلل من الحمل على خوادم FastAPI. |
| **آلية التنزيل (Download)** | **الوصول عبر CDN** | يتم تقديم الصور المُعالجة للمستخدمين عبر شبكة توصيل المحتوى (CDN) مثل AWS CloudFront أو Google Cloud CDN لضمان سرعة التحميل العالمية. |
| **إدارة البيانات** | **جدول `jobs`** | يتم تخزين مسارات الملفات (URLs/Keys) في جدول `jobs` في قاعدة البيانات بدلاً من تخزين الملفات نفسها. |

---

## 2. تطوير الواجهة الأمامية وتجربة المستخدم (Frontend & UX)

### أ. التحول إلى تطبيق ويب تقدمي (PWA)

| الميزة | التفاصيل | التبرير الاستراتيجي |
| :--- | :--- | :--- |
| **PWA Conversion** | إضافة ملف `manifest.json` و `service worker` لتوفير تجربة تشبه التطبيق الأصلي. | **تعزيز تجربة الموبايل:** يسمح للمستخدمين بتثبيت التطبيق على الشاشة الرئيسية (Home Screen) والوصول إليه بسرعة. |
| **Offline Capability** | يجب أن يعمل جزء من الواجهة الأمامية (مثل تصفح الصور المُعالجة سابقاً) دون اتصال جزئياً. | **تقليل مخاطر الاتصال:** يضمن أن المستخدم يمكنه تصفح النتائج السابقة حتى في ظروف الشبكة الضعيفة. |
| **التقنية** | استخدام **Next.js** أو **React** مع مكتبات PWA مُحسّنة. | يوازن بين سرعة الوصول للسوق (Time-to-Market) وتجربة المستخدم المتميزة على الموبايل، مما يلغي الحاجة لتطبيقات أصلية مكلفة في هذه المرحلة. |

### ب. تصميم لوحة تحكم المستخدم (User Dashboard Wireframe)

لوحة التحكم هي النقطة المركزية لإدارة الحسابات ونظام الـ Credits.

| المكون | الوظيفة | ملاحظات |
| :--- | :--- | :--- |
| **لوحة القيادة (Dashboard)** | عرض ملخص لعدد الـ Credits المتبقية، وآخر 5 مهام معالجة. | التركيز على الوضوح والشفافية في نظام الـ Credits. |
| **واجهة المعالجة** | واجهة تحميل الصور واختيار الوضعيات والخلفيات. | يجب أن تكون عملية من خطوة واحدة (Upload -> Select Options -> Process). |
| **سجل المعالجة (History)** | عرض جميع الصور المُعالجة، مع خيارات التنزيل والحذف. | يجب أن تكون قابلة للبحث والتصفية حسب نوع الموديل (بشري/خفي). |
| **إدارة الحساب** | تحديث البيانات الشخصية، تغيير كلمة المرور، إدارة الاشتراكات. | يجب أن تتضمن واجهة واضحة لشراء المزيد من الـ Credits. |

---

## 3. توسيع الميزات الأساسية (Core Feature Expansion)

### أ. مكتبة الوضعيات والخلفيات

يجب أن يتم تخزين جميع الوضعيات والخلفيات كأصول رقمية (Digital Assets) في S3/GCS، مع تخزين بياناتها الوصفية (Metadata) في قاعدة بيانات PostgreSQL.

| الميزة | التفاصيل | المتطلب التقني |
| :--- | :--- | :--- |
| **الوضعيات الديناميكية** | إضافة 10-15 وضعية جديدة (مثل الجلوس، المشي، وضعيات عرض الأزياء). | يجب أن يتم إنشاء خرائط وضعية (Pose Maps) عالية الجودة لكل وضعية لاستخدامها كمدخل لـ **ControlNet**. |
| **مكتبة الخلفيات** | إضافة 5-10 خلفيات احترافية (مثل استوديو فاخر، خلفية خارجية، متجر). | يجب أن تكون الخلفيات مُحسّنة لتعمل بشكل جيد مع نماذج الانتشار (Diffusion Models) وتدعم الإضاءة الواقعية. |
| **أداة اختيار اللون** | أداة بسيطة لاختيار لون خلفية صلب (Solid Color) (مثل أبيض، أسود، ألوان الباستيل). | يتم تمرير اللون المختار كـ Prompt إضافي لنموذج الذكاء الاصطناعي. |

### ب. نظام إدارة الحسابات والاشتراكات (Subscription / Credits System)

| المكون | الوظيفة | الهيكلية المقترحة |
| :--- | :--- | :--- |
| **النموذج** | **نظام قائم على الـ Credits** | يتم شراء حزم من الـ Credits، حيث تستهلك كل عملية معالجة صورة واحدة عدداً محدداً من الـ Credits (مثلاً: 1 Credit لكل صورة). |
| **التكامل المالي** | **Stripe أو PayPal** | التكامل مع بوابة دفع خارجية لإدارة الاشتراكات وشراء الـ Credits. |
| **قاعدة البيانات** | **جدول `users` و `transactions`** | يتم إضافة عمود `credits_balance` في جدول `users`. يتم إنشاء جدول `transactions` لتسجيل جميع عمليات الشراء والاستهلاك لضمان الدقة المالية. |

---

## 4. تحليل وإدارة المخاطر (Risk Management Focus)

| التحدي التقني | خطورة التحدي | خطة التغلب المقترحة في مرحلة V1.0 |
| :--- | :--- | :--- |
| **1. مخاطر التحول إلى PWA** | **متوسطة** | **التركيز على الوظائف الأساسية:** يجب أن يركز `service worker` في البداية على التخزين المؤقت (Caching) للواجهة الأمامية والأصول الثابتة فقط. تأجيل الوظائف المعقدة دون اتصال (مثل المعالجة المحلية) إلى ما بعد V1.0. |
| **2. خطر الأداء والتوسع** | **عالية** | **الاختبار تحت الحمل (Load Testing):** إجراء اختبارات إجهاد شاملة (Stress Testing) على نظام Celery/Redis قبل الإطلاق التجاري لضمان قدرته على التعامل مع 10 أضعاف الحمل المتوقع. **التحسين المستمر:** المراقبة المستمرة لطول قائمة الانتظار (Queue Length) لضبط التوسع التلقائي لوحدات الـ GPU. |
| **3. التكلفة التشغيلية للـ GPU** | **عالية** | **الاستخدام الفعال للـ GPU:** التأكد من أن عوامل Celery لا تبقى خاملة (Idle) أثناء تشغيل الـ GPU. يجب أن يتم تشغيل وإيقاف (Spin Up/Down) وحدات الـ GPU تلقائياً بناءً على طول قائمة الانتظار لتقليل التكاليف. |

---

## المراجع (References)

[1] FastAPI and Celery at Scale: Building Async Task Pipelines That Fly. *Medium* (Unknown). [URL: https://medium.com/@hadiyolworld007/fastapi-and-celery-at-scale-building-async-task-pipelines-that-fly-ef185527abf2]
[2] Creating a Distributed Task Queue in Python with Celery, Redis, and FastAPI. *Medium* (Unknown). [URL: https://medium.com/@bhagyarana80/creating-a-distributed-task-queue-in-python-with-celery-redis-and-fastapi-25bb6cb7ead0]
[3] Maximize Stable Diffusion performance and lower inference costs with AWS Inferentia2. *AWS Blog* (2023). [URL: https://aws.amazon.com/blogs/machine-learning/maximize-stable-diffusion-performance-and-lower-inference-costs-with-aws-inferentia2/]
[4] How I Run Stable Diffusion With ComfyUI on AWS, What it Costs and How it Benchmarks. *Medium* (2024). [URL: https://medium.com/@jankammerath/how-i-run-stable-diffusion-with-comfyui-on-aws-what-it-costs-and-how-it-benchmarks-caa79189cc65]
